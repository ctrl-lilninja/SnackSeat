<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Browse Shops</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Browse Shops</ion-title>
      <ion-buttons slot="end">
        <ion-button routerLink="/customer/my-reservations">
          <ion-icon name="list-outline"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Search and Filter Section -->
  <ion-card>
    <ion-card-content>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-icon name="search-outline" slot="start"></ion-icon>
            <ion-input
              placeholder="Search shop name..."
              [(ngModel)]="searchTerm"
              (ionInput)="onSearchChange($event)"
              clearInput="true">
            </ion-input>
          </ion-item>
        </ion-col>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-icon name="filter-outline" slot="start"></ion-icon>
            <ion-select
              placeholder="Filter by category"
              [(ngModel)]="selectedCategory"
              (ionChange)="onCategoryChange($event)">
              <ion-select-option value="">All Categories</ion-select-option>
              <ion-select-option *ngFor="let category of categories" [value]="category">
                {{ category }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-card-content>
  </ion-card>

  <!-- My Reservations Button -->
  <ion-card>
    <ion-card-content>
      <ion-button fill="solid" routerLink="/my-reservations" expand="block">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        My Reservations
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="isLoading">
    <ion-card-content>
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading shops...</p>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="!isLoading && shops.length === 0">
    <ion-card-content>
      <p>No shops available.</p>
    </ion-card-content>
  </ion-card>

  <ion-grid *ngIf="!isLoading && filteredShops.length > 0">
    <ion-row>
      <ion-col size="12" size-md="6" size-lg="4" *ngFor="let shop of filteredShops">
        <ion-card class="shop-card">
          <ion-card-header>
            <ion-card-title>{{ shop.name }}</ion-card-title>
            <ion-card-subtitle>{{ shop.category }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <p class="description">{{ shop.description }}</p>

            <!-- Rating Display -->
            <div class="rating-display" *ngIf="shop.ratingSummary && shop.ratingSummary.totalRatings > 0">
              <ion-row>
                <ion-col size="6">
                  <div class="rating-stars">
                    <ion-icon name="star" color="warning"></ion-icon>
                    <span class="rating-score">{{ shop.ratingSummary.averageRating }}</span>
                    <span class="rating-count">({{ shop.ratingSummary.totalRatings }})</span>
                  </div>
                </ion-col>
                <ion-col size="6">
                  <ion-button fill="clear" size="small" (click)="viewAllRatings(shop)">
                    View All Ratings
                  </ion-button>
                </ion-col>
              </ion-row>
            </div>

            <ion-row>
              <ion-col size="6">
                <p><strong>Phone:</strong></p>
                <a href="tel:{{ shop.phone }}" class="contact-link">{{ shop.phone }}</a>
              </ion-col>
              <ion-col size="6">
                <p><strong>Email:</strong></p>
                <a href="mailto:{{ shop.email }}" class="contact-link">{{ shop.email }}</a>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <p><strong>Available Seats:</strong> {{ shop.availableSeats }}</p>
              </ion-col>
              <ion-col size="6">
                <p><strong>Available Tables:</strong> {{ shop.availableTables }}</p>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <p><strong>Opening:</strong> {{ shop.openingTime }}</p>
              </ion-col>
              <ion-col size="6">
                <p><strong>Closing:</strong> {{ shop.closingTime }}</p>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="6">
                <p><strong>Status:</strong></p>
                <ion-badge [color]="shop.isOpen ? 'success' : 'danger'">
                  {{ shop.isOpen ? 'Open' : 'Closed' }}
                </ion-badge>
              </ion-col>
              <ion-col size="6">
                <p><strong>Reservation Date:</strong> {{ shop.reservationDate }}</p>
              </ion-col>
            </ion-row>

            <ion-button fill="solid" expand="block" (click)="reserve(shop)">
              <ion-icon name="calendar-outline" slot="start"></ion-icon>
              Reserve
            </ion-button>

            <ion-button fill="outline" expand="block" (click)="openDirections(shop)">
              <ion-icon name="navigate-outline" slot="start"></ion-icon>
              Get Directions
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
