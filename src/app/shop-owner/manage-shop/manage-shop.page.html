<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Manage Shop</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Manage Shop</ion-title>
    </ion-toolbar>
  </ion-header>


  <!-- Shop Owner Details Card if shop owner exists -->
  <ion-card *ngIf="shopOwner">
    <ion-card-header>
      <ion-card-title>{{ shopOwner.shopName }}</ion-card-title>
      <ion-card-subtitle>{{ shopOwner.category }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Description:</strong> {{ shopOwner.description }}</p>
      <p><strong>Email:</strong> {{ shopOwner.email }}</p>
      <p><strong>Contact:</strong> {{ shopOwner.contactNumber }}</p>
      <p><strong>Total Seats:</strong> {{ shopOwner.seats }}</p>
      <p><strong>Available Seats:</strong> {{ shopOwner.availableSeats }}
        <ion-button fill="clear" size="small" (click)="updateAvailableSeats()">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </p>
      <p><strong>Opening Time:</strong> {{ shopOwner.openingTime }}
        <ion-button fill="clear" size="small" (click)="updateOpeningTime()">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </p>
      <p><strong>Closing Time:</strong> {{ shopOwner.closingTime }}
        <ion-button fill="clear" size="small" (click)="updateClosingTime()">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </p>
      <p><strong>Reservation Date:</strong> {{ shopOwner.reservationDate }}
        <ion-button fill="clear" size="small" (click)="updateReservationDate()">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-button>
      </p>
      <p><strong>Status:</strong> {{ getShopStatus(shopOwner) ? 'Open' : 'Closed' }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Shops List Card -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>My Shops</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div *ngIf="shops.length > 0; else noShops">
        <ion-card *ngFor="let shop of shops" style="margin-bottom: 16px;">
          <ion-card-header>
            <ion-card-title>{{ shop.name }}</ion-card-title>
            <ion-card-subtitle>{{ shop.category }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <p><strong>Description:</strong> {{ shop.description }}</p>
            <p><strong>Available Seats:</strong> {{ shop.availableSeats }}</p>
            <p><strong>Status:</strong> {{ getShopStatus(shop) ? 'Open' : 'Closed' }}</p>
            <p><strong>Opening Time:</strong> {{ shop.openingTime }}</p>
            <p><strong>Closing Time:</strong> {{ shop.closingTime }}</p>
            <p><strong>Reservation Date:</strong> {{ shop.reservationDate }}</p>

            <!-- Ratings Section -->
            <div class="ratings-section" *ngIf="shop.ratingSummary && shop.ratingSummary.totalRatings > 0">
              <ion-row>
                <ion-col size="6">
                  <div class="rating-display">
                    <ion-icon name="star" color="warning"></ion-icon>
                    <span class="rating-score">{{ shop.ratingSummary.averageRating.toFixed(1) }}</span>
                    <span class="rating-count">({{ shop.ratingSummary.totalRatings }})</span>
                  </div>
                </ion-col>
                <ion-col size="6">
                  <ion-button fill="clear" size="small" (click)="viewShopRatings(shop)">
                    <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
                    View Ratings
                  </ion-button>
                </ion-col>
              </ion-row>
            </div>

            <ion-button fill="outline" color="primary" (click)="editShop(shop)">
              <ion-icon name="create" slot="start"></ion-icon>
              Edit
            </ion-button>
            <ion-button fill="outline" color="danger" (click)="removeShop(shop)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Remove
            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>
      <ng-template #noShops>
        <ion-item>
          <ion-label>
            <p>No shops yet. Click "Add Shop" to create your first shop.</p>
          </ion-label>
        </ion-item>
      </ng-template>
    </ion-card-content>
  </ion-card>

  <!-- Create Shop Modal -->
  <ion-modal [isOpen]="isCreating" (willDismiss)="isCreating = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Create Shop</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="isCreating = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="createShopForm" (ngSubmit)="createShop()">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Shop Details</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Shop Name *</ion-label>
                <ion-input formControlName="shopName" name="shopName" id="shopName" placeholder="Enter shop name"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Contact Email *</ion-label>
                <ion-input formControlName="email" name="email" id="email" type="email" placeholder="Enter email"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Contact Number *</ion-label>
                <ion-input formControlName="contactNumber" name="contactNumber" id="contactNumber" placeholder="Enter phone number"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Description *</ion-label>
                <ion-textarea formControlName="description" name="description" id="description" placeholder="Describe your shop"></ion-textarea>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Category *</ion-label>
                <ion-select formControlName="category" name="category" id="category" placeholder="Select category">
                  <ion-select-option *ngFor="let cat of categories" [value]="cat">{{cat}}</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Total Seats *</ion-label>
                <ion-input formControlName="seats" name="seats" id="seats" type="number" min="1"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Available Seats *</ion-label>
                <ion-input formControlName="availableSeats" name="availableSeats" id="availableSeats" type="number" min="0"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Opening Time *</ion-label>
                <ion-datetime formControlName="openingTime" display-format="HH:mm" picker-format="HH:mm"></ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Closing Time *</ion-label>
                <ion-datetime formControlName="closingTime" display-format="HH:mm" picker-format="HH:mm"></ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Reservation Date Availability *</ion-label>
                <ion-datetime formControlName="reservationDate" display-format="YYYY-MM-DD" picker-format="YYYY-MM-DD"></ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label>Shop Status</ion-label>
                <ion-toggle formControlName="isOpen" slot="end"></ion-toggle>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>Shop Location</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div id="map" style="height: 300px; width: 100%;"></div>

              <ion-item>
                <ion-label position="stacked">Latitude</ion-label>
                <ion-input formControlName="location.lat" name="location.lat" id="location.lat" type="number" step="0.000001"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Longitude</ion-label>
                <ion-input formControlName="location.lng" name="location.lng" id="location.lng" type="number" step="0.000001"></ion-input>
              </ion-item>

              <ion-button expand="block" (click)="saveLocation()" color="secondary">
                <ion-icon name="location" slot="start"></ion-icon>
                Save Location
              </ion-button>
            </ion-card-content>
          </ion-card>

          <ion-button expand="block" type="submit" [disabled]="createShopForm.invalid || isLoading">
            <ion-icon name="save" slot="start"></ion-icon>
            Create Shop
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edit Shop Modal -->
  <ion-modal [isOpen]="isEditing" (willDismiss)="isEditing = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Edit Shop</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="isEditing = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="editShopForm" (ngSubmit)="updateShop()">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Shop Details</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Shop Name *</ion-label>
                <ion-input formControlName="name" placeholder="Enter shop name"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Description *</ion-label>
                <ion-textarea formControlName="description" placeholder="Describe your shop"></ion-textarea>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Category *</ion-label>
                <ion-select formControlName="category" placeholder="Select category">
                  <ion-select-option *ngFor="let cat of categories" [value]="cat">{{cat}}</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Phone *</ion-label>
                <ion-input formControlName="phone" placeholder="Enter phone number"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Email *</ion-label>
                <ion-input formControlName="email" type="email" placeholder="Enter email"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Address *</ion-label>
                <ion-textarea formControlName="address" placeholder="Enter address"></ion-textarea>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Total Seats *</ion-label>
                <ion-input formControlName="totalSeats" type="number" min="1"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Available Seats *</ion-label>
                <ion-input formControlName="availableSeats" type="number" min="0"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Opening Time *</ion-label>
                <ion-datetime formControlName="openingTime" display-format="HH:mm" picker-format="HH:mm"></ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Closing Time *</ion-label>
                <ion-datetime formControlName="closingTime" display-format="HH:mm" picker-format="HH:mm"></ion-datetime>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Timezone *</ion-label>
                <ion-input formControlName="timezone" placeholder="e.g., Asia/Manila"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label>Shop Status</ion-label>
                <ion-toggle formControlName="isOpen" slot="end"></ion-toggle>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>Operating Days</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item *ngFor="let day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']">
                <ion-label>{{ day.charAt(0).toUpperCase() + day.slice(1) }}</ion-label>
                <ion-toggle [formControl]="$any(editShopForm.get('openDays.' + day + '.enabled'))" slot="end"></ion-toggle>
              </ion-item>

              <div *ngFor="let day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']" [formGroup]="$any(editShopForm.get('openDays.' + day))">
                <ion-item *ngIf="$any(editShopForm.get('openDays.' + day + '.enabled'))?.value">
                  <ion-label position="stacked">{{ day.charAt(0).toUpperCase() + day.slice(1) }} Hours</ion-label>
                  <ion-input formControlName="open" placeholder="Open time (HH:mm)" style="margin-right: 10px;"></ion-input>
                  <ion-input formControlName="close" placeholder="Close time (HH:mm)"></ion-input>
                </ion-item>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>Location</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Latitude *</ion-label>
                <ion-input formControlName="latitude" type="number" step="0.000001"></ion-input>
              </ion-item>

              <ion-item>
                <ion-label position="stacked">Longitude *</ion-label>
                <ion-input formControlName="longitude" type="number" step="0.000001"></ion-input>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <ion-button expand="block" type="submit" [disabled]="editShopForm.invalid || isLoading">
            <ion-icon name="save" slot="start"></ion-icon>
            Update Shop
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>


</ion-content>
